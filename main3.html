<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Шахматы с ИИ</title>
<style type="text/css">
body {
  background: #ddd6f3;
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 10px;
  text-align: center;
}
h1 {
  margin: 10px 0;
  font-size: 24px;
}
.board-wrap {
  border: 2px solid #333;
  padding: 5px;
  background: #fff;
  display: inline-block;
  max-width: 100%;
}
#board {
  margin: 0 auto;
  border: 2px solid #333;
  width: 320px;
  max-width: 95vw;
}
table {
  border-collapse: collapse;
  width: 100%;
  table-layout: fixed;
}
td {
  width: 12.5%;
  height: 12.5vw;
  max-height: 40px;
  max-width: 40px;
  text-align: center;
  vertical-align: middle;
  font-size: 6vw;
  cursor: pointer;
  border: 1px solid #888;
}
.light {
  background: #f5e1c4;
}
.dark {
  background: #b97a57;
}
.selected {
  outline: 2px solid yellow;
}
.hint {
  background: #ffff99;
}
#info {
  margin: 10px auto;
  font-size: 16px;
}
button {
  padding: 8px 16px;
  margin: 5px;
  font-size: 14px;
}
footer {
  font-size: 12px;
  margin-top: 15px;
  color: #333;
}

/* Оптимизация для мобильных устройств */
@media screen and (max-width: 480px) {
  body {
    padding: 5px;
  }
  h1 {
    font-size: 20px;
  }
  #board {
    width: 280px;
  }
  td {
    height: 10vw;
    font-size: 5vw;
  }
  #info {
    font-size: 14px;
  }
}

@media screen and (max-width: 320px) {
  #board {
    width: 240px;
  }
  td {
    height: 8vw;
    font-size: 4vw;
  }
}
</style>
<script type="text/javascript">
// Глобальные переменные
var piecesStart, glyph, board, selected, whiteTurn, possibleMoves, castling, enPassant;

function initGame() {
  piecesStart = [
    ["r","n","b","q","k","b","n","r"],
    ["p","p","p","p","p","p","p","p"],
    ["","","","","","","",""],
    ["","","","","","","",""],
    ["","","","","","","",""],
    ["","","","","","","",""],
    ["P","P","P","P","P","P","P","P"],
    ["R","N","B","Q","K","B","N","R"]
  ];
  
  glyph = {
    'r':'♜','n':'♞','b':'♝','q':'♛','k':'♚','p':'♟',
    'R':'♖','N':'♘','B':'♗','Q':'♕','K':'♔','P':'♙','':''
  };
  
  board = copyArray(piecesStart);
  selected = null;
  whiteTurn = true;
  possibleMoves = [];
  castling = {whiteK:true, whiteQ:true, blackK:true, blackQ:true};
  enPassant = null;
  
  renderBoard();
  updateTurnDisplay();
}

function copyArray(arr) {
  var newArr = [];
  for (var i = 0; i < arr.length; i++) {
    newArr[i] = arr[i].slice();
  }
  return newArr;
}

function renderBoard() {
  var wrap = document.getElementById("board");
  var html = "<table cellpadding='0' cellspacing='0'>";
  
  for (var r = 0; r < 8; r++) {
    html += "<tr>";
    for (var c = 0; c < 8; c++) {
      var color = ((r + c) % 2 == 0) ? 'light' : 'dark';
      var piece = board[r][c] || "";
      var disp = glyph[piece] || "";
      var extra = "";
      
      if (selected && selected.r == r && selected.c == c) {
        extra = " selected";
      }
      
      if (possibleMoves.length > 0) {
        for (var i = 0; i < possibleMoves.length; i++) {
          if (possibleMoves[i].r == r && possibleMoves[i].c == c) {
            extra += " hint";
            break;
          }
        }
      }
      
      html += '<td class="' + color + extra + '" onclick="cellClick(' + r + ',' + c + ')">' + disp + '</td>';
    }
    html += "</tr>";
  }
  html += "</table>";
  
  wrap.innerHTML = html;
}

function cellClick(r, c) {
  if (!whiteTurn) return;
  
  var piece = board[r][c];
  
  if (!selected) {
    if (piece && isWhite(piece)) {
      selected = {r: r, c: c};
      possibleMoves = calcMoves(r, c, true);
    }
  } else {
    if (selected.r == r && selected.c == c) {
      selected = null;
      possibleMoves = [];
    } else {
      var moveValid = false;
      for (var i = 0; i < possibleMoves.length; i++) {
        if (possibleMoves[i].r == r && possibleMoves[i].c == c) {
          moveValid = true;
          break;
        }
      }
      
      if (moveValid) {
        movePiece(selected.r, selected.c, r, c);
        whiteTurn = false;
        updateTurnDisplay();
        
        // Адаптивная задержка для ИИ в зависимости от устройства
        var delay = 300;
        if (navigator.userAgent.match(/Mobile/)) {
          delay = 100; // Быстрее на мобильных
        }
        setTimeout(aiMove, delay);
      } else {
        if (piece && isWhite(piece)) {
          selected = {r: r, c: c};
          possibleMoves = calcMoves(r, c, true);
        } else {
          selected = null;
          possibleMoves = [];
        }
      }
    }
  }
  
  renderBoard();
}

function movePiece(sr, sc, dr, dc) {
  var piece = board[sr][sc];
  
  // Взятие на проходе
  if (piece == "P" && enPassant && dr == enPassant.r && dc == enPassant.c) {
    board[dr][dc] = piece;
    board[sr][sc] = "";
    board[dr+1][dc] = "";
  } else if (piece == "p" && enPassant && dr == enPassant.r && dc == enPassant.c) {
    board[dr][dc] = piece;
    board[sr][sc] = "";
    board[dr-1][dc] = "";
  } else {
    board[dr][dc] = piece;
    board[sr][sc] = "";
  }
  
  // Превращение пешки
  if (piece == "P" && dr == 0) board[dr][dc] = "Q";
  if (piece == "p" && dr == 7) board[dr][dc] = "q";
  
  // Рокировка
  if (piece == "K" && sc == 4 && (dc == 6 || dc == 2)) {
    if (dc == 6) {
      board[7][5] = "R";
      board[7][7] = "";
    }
    if (dc == 2) {
      board[7][3] = "R";
      board[7][0] = "";
    }
    castling.whiteK = false;
    castling.whiteQ = false;
  }
  if (piece == "k" && sc == 4 && (dc == 6 || dc == 2)) {
    if (dc == 6) {
      board[0][5] = "r";
      board[0][7] = "";
    }
    if (dc == 2) {
      board[0][3] = "r";
      board[0][0] = "";
    }
    castling.blackK = false;
    castling.blackQ = false;
  }
  
  // Установка en passant
  enPassant = null;
  if (piece == "P" && sr == 6 && dr == 4) enPassant = {r: 5, c: sc};
  if (piece == "p" && sr == 1 && dr == 3) enPassant = {r: 2, c: sc};
  
  selected = null;
  possibleMoves = [];
}

function isWhite(p) {
  return p == p.toUpperCase() && p != "";
}

function isBlack(p) {
  return p == p.toLowerCase() && p != "";
}

function calcMoves(r, c, isWhiteSide) {
  var piece = board[r][c];
  var moves = [];
  if (!piece) return moves;
  
  // Пешка
  if (piece == "P") {
    if (r > 0 && !board[r-1][c]) moves.push({r: r-1, c: c});
    if (r == 6 && !board[5][c] && !board[4][c]) moves.push({r: 4, c: c});
    if (r > 0 && c > 0 && isBlack(board[r-1][c-1])) moves.push({r: r-1, c: c-1});
    if (r > 0 && c < 7 && isBlack(board[r-1][c+1])) moves.push({r: r-1, c: c+1});
    if (enPassant && r == 3 && Math.abs(c - enPassant.c) == 1) {
      moves.push({r: enPassant.r, c: enPassant.c});
    }
  }
  
  if (piece == "p") {
    if (r < 7 && !board[r+1][c]) moves.push({r: r+1, c: c});
    if (r == 1 && !board[2][c] && !board[3][c]) moves.push({r: 3, c: c});
    if (r < 7 && c > 0 && isWhite(board[r+1][c-1])) moves.push({r: r+1, c: c-1});
    if (r < 7 && c < 7 && isWhite(board[r+1][c+1])) moves.push({r: r+1, c: c+1});
    if (enPassant && r == 4 && Math.abs(c - enPassant.c) == 1) {
      moves.push({r: enPassant.r, c: enPassant.c});
    }
  }
  
  // Ладья
  if (piece.toLowerCase() == "r") {
    addLineMoves(r, c, moves, [[-1,0],[1,0],[0,-1],[0,1]], piece);
  }
  
  // Слон
  if (piece.toLowerCase() == "b") {
    addLineMoves(r, c, moves, [[-1,-1],[-1,1],[1,-1],[1,1]], piece);
  }
  
  // Ферзь
  if (piece.toLowerCase() == "q") {
    addLineMoves(r, c, moves, [[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1],[1,-1],[1,1]], piece);
  }
  
  // Конь
  if (piece.toLowerCase() == "n") {
    addStepMoves(r, c, moves, [[2,1],[2,-1],[-2,1],[-2,-1],[1,2],[1,-2],[-1,2],[-1,-2]], piece);
  }
  
  // Король
  if (piece.toLowerCase() == "k") {
    addStepMoves(r, c, moves, [[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1],[1,-1],[1,1]], piece);
    
    // Рокировка
    if (piece == "K" && r == 7 && c == 4) {
      if (castling.whiteK && !board[7][5] && !board[7][6]) moves.push({r: 7, c: 6});
      if (castling.whiteQ && !board[7][1] && !board[7][2] && !board[7][3]) moves.push({r: 7, c: 2});
    }
    if (piece == "k" && r == 0 && c == 4) {
      if (castling.blackK && !board[0][5] && !board[0][6]) moves.push({r: 0, c: 6});
      if (castling.blackQ && !board[0][1] && !board[0][2] && !board[0][3]) moves.push({r: 0, c: 2});
    }
  }
  
  return moves;
}

function addLineMoves(r, c, moves, dirs, piece) {
  for (var i = 0; i < dirs.length; i++) {
    var d = dirs[i];
    var nr = r + d[0];
    var nc = c + d[1];
    
    while (nr >= 0 && nr < 8 && nc >= 0 && nc < 8) {
      if (!board[nr][nc]) {
        moves.push({r: nr, c: nc});
      } else {
        if (isWhite(piece) && isBlack(board[nr][nc])) moves.push({r: nr, c: nc});
        if (isBlack(piece) && isWhite(board[nr][nc])) moves.push({r: nr, c: nc});
        break;
      }
      nr += d[0];
      nc += d[1];
    }
  }
}

function addStepMoves(r, c, moves, steps, piece) {
  for (var i = 0; i < steps.length; i++) {
    var s = steps[i];
    var nr = r + s[0];
    var nc = c + s[1];
    
    if (nr >= 0 && nr < 8 && nc >= 0 && nc < 8) {
      if (!board[nr][nc]) {
        moves.push({r: nr, c: nc});
      } else {
        if (isWhite(piece) && isBlack(board[nr][nc])) moves.push({r: nr, c: nc});
        if (isBlack(piece) && isWhite(board[nr][nc])) moves.push({r: nr, c: nc});
      }
    }
  }
}

// ИИ среднего уровня
function aiMove() {
  var pieceValue = {p:1, n:3, b:3, r:5, q:9, k:100};
  var allMoves = [];
  
  for (var r = 0; r < 8; r++) {
    for (var c = 0; c < 8; c++) {
      if (isBlack(board[r][c])) {
        var moves = calcMoves(r, c, false);
        for (var i = 0; i < moves.length; i++) {
          var m = moves[i];
          var target = board[m.r][m.c] || "";
          var val = isWhite(target) ? pieceValue[target.toLowerCase()] || 0 : 0;
          allMoves.push({sr: r, sc: c, dr: m.r, dc: m.c, score: val});
        }
      }
    }
  }
  
  if (allMoves.length > 0) {
    // Сортировка по очкам
    for (var i = 0; i < allMoves.length - 1; i++) {
      for (var j = i + 1; j < allMoves.length; j++) {
        if (allMoves[j].score > allMoves[i].score) {
          var temp = allMoves[i];
          allMoves[i] = allMoves[j];
          allMoves[j] = temp;
        }
      }
    }
    
    var best = allMoves[0];
    movePiece(best.sr, best.sc, best.dr, best.dc);
  }
  
  whiteTurn = true;
  updateTurnDisplay();
  renderBoard();
}

function updateTurnDisplay() {
  var turnText = whiteTurn ? "Ход: белые" : "Ход: чёрные (ИИ)";
  document.getElementById("turn").innerHTML = turnText;
}

function resetGame() {
  initGame();
}

// Инициализация при загрузке
window.onload = initGame;
</script>
</head>

<body>
<h1>Шахматы с ИИ</h1>

<div class="board-wrap">
  <div id="board"></div>
</div>

<div id="info">
  <div id="turn">Ход: белые</div>
  <button onclick="resetGame()">Сбросить игру</button>
</div>

<footer>Шахматы с ИИ среднего уровня (оптимизировано для мобильных устройств)</footer>

</body>
</html>